#前言
最近开始自学python,接触到一个python发送邮件的模块。突发奇想，既然QQ总是给我发送好友生日的邮件提醒，那我何不自己搞一个自动发送邮件的功能呢，说干就干，立马开始收集资料。经过资料整理，我确定了我的实现思路：
>1. 首先利用sql server数据库来存储我想要设置提醒的好友生日信息
>2. 使用python提供的pymssql模块连接数据库，读取数据
>3. 通过程序逻辑取到当天生日的好友信息
>4. 再利用smtplib模块连接邮件服务器实现生日祝福的邮件自动发送


#一、数据准备
## 1.收集好友生日信息
收集好友信息部分因人而异，可以直接问（但估计一般人不会这么直接），也可以通过QQ、微信上的资料收集，这样还能顺便得到对方的邮箱。因为我主要是为了体验自动发送邮件的功能。直接拿了大学同班同学的信息统计（原谅我，在这个大数据时代，实在是没有隐私可以，随便一找就找到了全校的信息。但其他人我也不认识，给他们发邮件怕不是要顺着网线来打我）
我收集的信息格式如下：

| 姓名   | 身份证号 | 电话   | 邮箱   |
| ---- | ---- | ---- | ---- |
| xxx  | xxx  | xxx  | xxx  |

再根据身份证号的特性利用EXCEL的函数  ``=TEXT(MID(B2,7,8),"#-00-00")`` 取出生日信息。

我相信有兴趣学习python的朋友应该都懂一些Excel的函数操作，如果上一步提取生日信息不会也没关系。可以将数据导入数据库后再进行处理。

最终格式如下：

| 姓名   | 身份证号 | 生日   | 电话   | 邮箱   |
| ---- | ---- | ---- | ---- | ---- |
|      |      |      |      |      |

![](C:\Users\41533\Documents\markdown学习\images\birthday.png)

注：其实到这一步，身份证号已经完全没有作用了，存着也只是徒增信息泄露的风险，可以考虑直接删掉。

但我在这里并没有删除，一方面是留作备用，另一方面是我打算稍后用简单的加密算法对身份证号和电话进行加密。

## 2.数据入库

### 2.1 创建一个名为BIRTHDAY的数据库并导入数据

```sql
CREATE DATABASE BIRTHDAY
ON (
	NAME = 'BIRTHDAY',
	FILENAME = 'D:\SeqData\BIRTHDAY.mdf',
	SIZE = 5,
	MAXSIZE = UNLIMITED,
	FILEGROWTH = 1	
)
LOG ON(
	NAME = 'BIRTHDAY_LOG',
	FILENAME = 'D:\SeqData\BIRTHDAY_LOG.ldf',
	SIZE = 3,
	MAXSIZE = UNLIMITED,
	FILEGROWTH = 1
)
```
> 2.1.1.选中创建的数据库，右键选择任务、导入数据。进入导入导出向导工具导入数据
> <img src="C:\Users\41533\Documents\markdown学习\images/14.png"  style="zoom:50%">
> 2.1.2 提示信息，直接下一步
> <img src="C:\Users\41533\Documents\markdown学习\images/02.png"  style="zoom:50%">
> 2.1.3 数据源选择Excel,选择文件路径，如果收集的数据首行有列名称。就勾选。版本会自动匹配，下一步
> <img src="C:\Users\41533\Documents\markdown学习\images/03.png"  style="zoom:50%">
> 2.1.4  这里我使用的数据库为SQL SERVER，故目标选择SQL Server Native Client,填入管理员密码，数据库会默认为前边选中的数据库，下一步
>
> <img src="C:\Users\41533\Documents\markdown学习\images/04.png"  style="zoom:50%">
> 2.1.5 默认选择复制一个或多个表或视图的数据，下一步
> <div align = center><img src="C:\Users\41533\Documents\markdown学习\images/05.png"  style="zoom:50%"></div>
> 2.1.6 选中存放数据的表名，最后一个‘$’是系统加的，EXCEL里的表没有这个符号，然后点击编辑映射
> <img src="C:\Users\41533\Documents\markdown学习\images/06.png" style="zoom:50%">
> 2.1.7 更改一下数据类型，默认为nvarchar，这里改为varchar,至于两者的区别，这里不作展开，感兴趣可以自行百度一下，注意生日使用date就行，精度为天，如果选了datetime，精度到分钟，浪费空间。编辑好就确定，下一步
> <img src="C:\Users\41533\Documents\markdown学习\images/07.png"  style="zoom:50%">
> 2.1.8 将出错和截断时的措施都改为忽略，下一步
> <img src="C:\Users\41533\Documents\markdown学习\images/08.png" style="zoom:50%">
> 2.1.9 按提示立即运行就行
> <img src="C:\Users\41533\Documents\markdown学习\images/09.png"  style="zoom:50%">
> <img src="C:\Users\41533\Documents\markdown学习\images/10.png"  style="zoom:50%">
> 2.1.10 导入完成，但我源数据就40多行，哪来的传输949行，问号脸？？？等下查看原因
> <img src="C:\Users\41533\Documents\markdown学习\images/11.png"  style="zoom:50%">
> 2.1.11 查看表发现有大量空行，需要将这些行删掉。
> <img src="C:\Users\41533\Documents\markdown学习\images/12.png"  style="zoom:50%">

##2. 处理数据
这里我创建一个新表，将有效数据插入进去
```sql
  CREATE TABLE tb_birthday
  (
	name VARCHAR(20),
	IDcard VARCHAR(20),
	birthday DATE,
	phoneNumber VARCHAR(15),
	email VARCHAR(20)
  )
  INSERT INTO tb_birthday([name], [IDcard], [birthday], [phoneNumber], [email])
  SELECT name, IDcard, birthday, phoneNumber, email
  FROM [BIRTHDAY].[dbo].[团员信息$]
  WHERE name IS NOT NULL
```

这一步中，如果前边没有在Excel中利用身份证号提取出生日信息的话，给出另一种插入方式	

利用SQL提供的函数截取身份证号的7-14位即为生日

```sql
  INSERT INTO tb_birthday([name], [IDcard], [birthday], [phoneNumber], [email])
  SELECT name, IDcard, SUBSTRING(IDcard, 7, 8) AS birthday, phoneNumber, email
  FROM [BIRTHDAY].[dbo].[团员信息$]
  WHERE name IS NOT NULL
```

## 3. 加密数据

由于生日信息必须存在，故我只对身份证号的前6位以及手机号的中间4位进行加密。方式很简单，所有数字加一后逆置即可。各位单独运算不进位，遇9变0。举例：假设原来数字为911015，加一变成022126，逆置为621220。解密时只需逆置再减一就好。规则简单，只是简单的避免明文数据泄露，当然如果数据很重要，建议使用专业的数据加密算法进行加密。

尝试后发现方法可行

<img src="C:\Users\41533\Documents\markdown学习\images/15.png"  style="zoom:50%">

```SQL
UPDATE tb_birthday
SET IDcard = REVERSE(CONCAT(((SUBSTRING(IDcard, 1, 1) + 1) % 10), ((SUBSTRING(IDcard, 2, 1) + 1) % 10), ((SUBSTRING(IDcard, 3, 1) + 1) % 10), ((SUBSTRING(IDcard, 4, 1) + 1) % 10), ((SUBSTRING(IDcard, 5, 1) + 1) % 10), ((SUBSTRING(IDcard, 6, 1) + 1) % 10))) + SUBSTRING(IDcard, 7, 12),
phoneNumber = SUBSTRING(phoneNumber, 1, 3) + REVERSE(CONCAT(((SUBSTRING(phoneNumber, 4, 1) + 1) % 10), ((SUBSTRING(phoneNumber, 5, 1) + 1) % 10), ((SUBSTRING(phoneNumber, 6, 1) + 1) % 10), ((SUBSTRING(phoneNumber, 7, 1) + 1) % 10))) + SUBSTRING(phoneNumber, 8, 4)
```

考虑到以后还可能会往表里添加数据，不可能每次添加后都单独进行加密。我为该表创建了一个触发器，当添加了新数据后自动对其加密(如果不需要请忽略)

```sql
CREATE TRIGGER trig_encrypt_tb_birthday
-- 自动加密身份证号和手机号
ON tb_birthday
FOR INSERT
AS
BEGIN
	DECLARE @IDcard VARCHAR(20)
	DECLARE @IDcard_eccrypt VARCHAR(20)
	DECLARE @phoneNumber VARCHAR(15)
	DECLARE @phoneNumber_eccrypt VARCHAR(15)
	DECLARE @name VARCHAR(100)
	DECLARE @email VARCHAR(100)
	SELECT @name = [name], @IDcard = [IDcard], @phoneNumber = [phoneNumber], @email = [email] 
	FROM inserted

	SET @IDcard_eccrypt = REVERSE(CONCAT(((SUBSTRING(@IDcard, 1, 1) + 1) % 10), ((SUBSTRING(@IDcard, 2, 1) + 1) % 10), ((SUBSTRING(@IDcard, 3, 1) + 1) % 10), ((SUBSTRING(@IDcard, 4, 1) + 1) % 10), ((SUBSTRING(@IDcard, 5, 1) + 1) % 10), ((SUBSTRING(@IDcard, 6, 1) + 1) % 10))) + SUBSTRING(@IDcard, 7, 12)

	SET @phoneNumber_eccrypt = SUBSTRING(@phoneNumber, 1, 3) + REVERSE(CONCAT(((SUBSTRING(@phoneNumber, 4, 1) + 1) % 10), ((SUBSTRING(@phoneNumber, 5, 1) + 1) % 10), ((SUBSTRING(@phoneNumber, 6, 1) + 1) % 10), ((SUBSTRING(@phoneNumber, 7, 1) + 1) % 10))) + SUBSTRING(@phoneNumber, 8, 4)

	UPDATE tb_birthday
	SET IDcard = @IDcard,
		phoneNumber = @phoneNumber
	WHERE name = @name 
	AND email = @email
END
```
#二、连接数据库

## 1. 安装pymysql

打开PyCharm,创建一个新的项目，点击左下方的Terminal
<img src="C:\Users\41533\Documents\markdown学习\images/21.png"  style="zoom:50%">
输入命令``pip install pymssql``,提示安装成功
<img src="C:\Users\41533\Documents\markdown学习\images/20.png"  style="zoom:50%">

注：这里没有使用常用的pymysql,而是使用了pymssql，主要是因为我电脑上同时装了mysql和sqlserver,而pymysql模块会自动连接mysql，尝试了很多办法还是没能解决，所以采用了专门连接SQL server的pymssql模块，语法格式非常接近。根据个人情况灵活选择就好

## 2. 使用pymssql连接数据库并执行SQL语句

```python
# 导入pymssql包
import pymssql

# 1. 连接数据库, 设置主机名，账户和登录密码，以及要连接的数据库
host = 'localhost'
user = 'root'
password = 'root'
database = 'BIRTHDAY'
# 使用pymssql的connect方法创建一个数据库连接
connect = pymssql.connect(host, user, password, database)
# 连接成功
if connect:
    # 声明一个游标，用来执行SQL语句
    cursor = connect.cursor()
    # 2. 编写SQL语句并执行
    sql = "select top 10 name, birthday, email from tb_birthday"
    cursor.execute(sql)
    # 3. 输出结果
    # 输出一条记录fetchone（）,输出多条记录fetchall()
    print(cursor.fetchone())
    print(cursor.fetchall())
    # 4. 关闭连接
    cursor.close()
    connect.close()
# 连接失败
else:
    print('连接失败')
```
运行程序后打印出一条记录，红色提示为pymssql在未来版本将不再支持，不推荐使用，可以忽略
<img src="C:\Users\41533\Documents\markdown学习\images/23.png"  style="zoom:50%">

## 3. 封装SQL SERVER连接方法

上述代码虽然能成功查询，但由于最终目的是实现邮件的自动发送，连接数据库只是其中一步，故应该对方法进行封装，供主函数调用即可。

> 2.3.1  创建一个新的python文件，命名为SqlServer,实现数据库的连接、执行和关闭

```python
# 注： 此段代码参考了b站up优就业的视频，链接https://www.bilibili.com/video/BV17J411C7Gv/?p=2
import pymssql

class SqlServer():
    # 初始化方法，接收参数
    def __init__(self, host, user, password, database):
        self.host = host
        self.user = user
        self.password = password
        self.database = database

    # 创建数据库连接并生成游标
    def connect(self):
        self.dbconnect = pymssql.connect(self.host, self.user, self.password, self.database)
        self.cursor = self.dbconnect.cursor()

    # 获取一条数据
    def get_one(self, sql):
        result = 0
        try:
            self.connect()
            self.cursor.execute(sql)
            result = self.cursor.fetchone()
            self.close()
        except Exception as E:
            print('error:', E)
        return result

    # 获取多条数据
    def get_all(self, sql):
        result = 0
        try:
            self.connect()
            self.cursor.execute(sql)
            result = self.cursor.fetchall()
            self.close()
        except Exception as E:
            print('error', E)
        return result

    # 关闭连接
    def close(self):
        self.cursor.close()
        self.dbconnect.close()
```

# 三、 连接邮箱服务器

## 1. 登录自己的邮箱账号，并建立连接

连接邮箱服务器主要用到smtplib、email两个包，均为python自带。不需要额外安装，直接引用就好

> 3.1.1 根据自己要使用的邮箱，确定邮件服务器和端口号

> >a. 网易163邮箱：邮件服务器: smtp.163.com, 端口号: 465
> >
> >b. QQ邮箱： 邮件服务器: smtp.qq.com, 端口号: 465

> 3.1.2 设置邮箱授权码
>
> 不同于数据库的登录，邮箱在登录时是采用邮箱地址+授权码的方式登录的。具体设置方式点击链接查看
>
> >a. [网易163邮箱](https://help.mail.163.com/faqDetail.do?code=d7a5dc8471cd0c0e8b4b8f4f8e49998b374173cfe9171305fa1ce630d7f67ac2cda80145a1742516)
> >b. [QQ邮箱](https://service.mail.qq.com/cgi-bin/help?subtype=1&id=28&no=1001256)
>

确定了自己要用的邮箱，并且设置了授权码后，就可以编写python实现邮件自动发送了

主要步骤为

> > 1. 连接邮箱服务器、登录邮箱
> > 2. 设置邮件标题、正文
> > 3. 发送邮件、关闭链接

```python
#　此代码参考了ｂ站up酒坛坛儿的视频，视频地址https://www.bilibili.com/video/BV1Lg4y187ic/
import smtplib
from email.mime.multipart import MIMEMultipart      # 创建邮件对象（被发送的东西）
from email.header import Header     # 创建邮件主题（邮件主题）
from email.mime.text import MIMEText    # 创建邮件内容（邮件正文）

# 1.连接邮件服务器
# 1）smtplib.SMTP_SSL(邮箱服务器. 端口号)
con = smtplib.SMTP_SSL('smtp.163.com', 465)
# 2)登录邮箱
# con.login(邮箱地址, 授权码）
''' 
注：con.login()正常情况下只需填写授权码即可，但此处若我的授权码写成明文的话就可以被别人随便登录了。
故我提前在项目文件下创建了一个文件夹files、再创建一个password文件用来保存我的授权码
使用时只需要读文件即可得到授权码。可以不用模仿
'''
con.login('17073858552@163.com', open('files/password', encoding='utf-8').read())

# 2.准备数据
# 1）创建邮件对象
msg = MIMEMultipart()
# 2）设置邮件主题
# Header(标题， 编码方式)
subject = Header('生日祝福', 'utf-8').encode()
msg['Subject'] = subject
# 设置邮件发送人： 邮箱地址<邮箱地址>
msg['From'] = '17073858552@163.com <17073858552@163.com>'
# 设置邮件收件人
# '收件人1；收件人2；...'
msg['To'] = '415331174@qq.com'
# 3)设置邮件正文
# 普通文本：MIMEText(文本内容，文本类型，编码方式)
# 文本类型 -plain(普通文字)、html(超链接)、base64(二进制文件，即附件)
text = MIMEText('生日快乐！', 'plain', 'utf-8')
msg.attach(text)

# 3.发送邮件
# 连接对象.sendmail(发件人， 收件人， 字符串类型的邮件对象)
con.sendmail('17073858552@163.com', '415331174@qq.com', msg.as_string())
con.quit()
```

此处使用我的网易邮箱给我的QQ邮箱发送一封主题为生日祝福、内容为‘生日快乐！’的邮件，运行程序查看效果

<img src="C:\Users\41533\Documents\markdown学习\images/24.png"  style="zoom:50%">

红框分别对应邮件主题、发件人、收件人和内容，测试成功！离成功很近啦

## 2. 封装邮箱连接方法

3.2.1  创建一个新的python文件，命名为Email,实现的邮箱的连接、邮件的发送和连接关闭

```python
import smtplib
from email.mime.multipart import MIMEMultipart
from email.header import Header
from email.mime.text import MIMEText

class Email():
    def __init__(self, MailServer, port, email, password):
        self.MailServer = MailServer
        self.port = port
        self.email = email
        self.password = password


    def connect(self):
        self.con = smtplib.SMTP_SSL(self.MailServer, self.port)
        self.con.login(self.email, self.password)


    def sendmail(self, Sender, To, Subject, Text):
        self.connect()
        msg = MIMEMultipart()
        # 设置邮件主题
        subject = Header(Subject, 'utf-8').encode()
        msg['Subject'] = subject
        # 设置邮件发送人： 邮箱地址<邮箱地址>
        From = self.Senter_to_from(Sender)
        msg['From'] = From
        # 设置邮件收件人
        msg['To'] = To
        # 设置邮件正文
        text = MIMEText(Text, 'plain', 'utf-8')
        msg.attach(text)

        # 发送邮件
        self.con.sendmail(Sender, To, msg.as_string())
        self.close()

    def close(self):
        self.con.quit()


    def Senter_to_from(self, Sender):
        From = Sender + '<' + Sender + '>'
        return From
```



# 四、 实现邮件自动发送

在最终实现邮件自动发送前，还有最后一个问题需要解决：数据库里储存的birthday是年-月-日，而判断生日只需要月-日匹配即可。通过SQL语句的where子句编写很容易就能实现``where right(birthday, 5) = '07-26'``

而``07-26`` 这种月-日的格式生日，则只需简单引入一个datetime包即可

```python
import datetime
today = datetime.date.today().strftime("%m-%d")
sql = 'select top 10 name, email from tb_birthday ' + ' where right(birthday, 5) = \'' + today + '\''
```

最终测试代码如下

```python
"""
 @author : 唐仕恒
 @filename : test_邮件自动发送.py
 @createtime :2020/6/26 22:12
 @IDE : PyCharm
"""
# -*- coding: UTF-8 -*-
from SqlServer import SqlServer
from Email import Email
import datetime

def main():
    host = 'localhost'
    user = 'root'
    password = 'root'
    database = 'BIRTHDAY'
    # 连接数据库
    connect = SqlServer(host, user, password, database)
    # 查询当前日期是否有人生日
    today = datetime.date.today().strftime("%m-%d")
    sql = 'select top 10 name, email from tb_birthday ' + ' where right(birthday, 5) = \'' + today + '\''
    result = connect.get_all(sql)
    # 如果有人生日，发送生日祝福邮件
    if result:
        # 有记录，建立邮箱连接
        MailServer = 'smtp.163.com'
        port = 465
        email = '17073858552@163.com'
        password = open('files/password', encoding='utf-8').read()
        emailConnect = Email(MailServer, port, email, password)
        # 设置发件人和邮件主题
        sender = '17073858552@163.com'
        subject = '生日祝福'
        # 多个人同一天生日时发送多份邮件
        for row in result:

            # 收件人
            name = row[0]
            to = row[1]
            text = name + ',祝你生日快乐！'
            print(name, to)
            # 自动发送邮件
            emailConnect.sendmail(sender, to, subject, text)
            print('邮件发送成功')

if __name__ == '__main__':
    main()
```

为了测试是否有效，向数据库中插入一条姓名为李四，生日为6月26，邮箱为我的QQ邮箱的记录

```sql
insert into tb_birthday
values('李四', '413024197806263445', '19980626', '17243238452', '415331174@qq.com')
```

执行代码，查看我的QQ邮箱是否收到邮件

<img src="C:\Users\41533\Documents\markdown学习\images/26.png"  style="zoom:50%">
yes,成功收到！大功告成！但还没到激动的时候，因为还有最最最后一步

# 五、 设置定时任务执行python代码

不同于大公司在服务器上部署代码，这里写的代码是在自己电脑上的，可以看到，只有当我执行了代码时。才会连接数据库查询当天是否有人生日，如果每天都要自己执行一遍的话，那还不如直接手动给人发个祝福来的实在。所以，最后要想办法解决怎样才能让代码自动执行。

问了度娘之后，发现win10自带的有一个任务计划程序功能，类似于数据库里的作业。可以设置定时自动执行指定任务。刚好符合要求。

> 5.1 打开资源管理器，选中我的电脑，点击上方管理
> <img src="C:\Users\41533\Documents\markdown学习\images/30.png"  style="zoom:50%">
> 5.2 选中任务计划程序，点击创建基本任务
> <img src="C:\Users\41533\Documents\markdown学习\images/31.png"  style="zoom:50%">
> 5.3 编写计划名称和描述
> <img src="C:\Users\41533\Documents\markdown学习\images/32.png"  style="zoom:50%">
> 5.4  设置执行间隔为每天
> <img src="C:\Users\41533\Documents\markdown学习\images/33.png"  style="zoom:50%">
> 5.5 设置开始时间
> <img src="C:\Users\41533\Documents\markdown学习\images/34.png"  style="zoom:50%">
> 5.6 操作为启动程序
> <img src="C:\Users\41533\Documents\markdown学习\images/35.png"  style="zoom:50%">
> 5.7 程序或脚本，为python.exe的安装目录
> <img src="C:\Users\41533\Documents\markdown学习\images/36.png"  style="zoom:50%">
> 5.8 添加参数即为要运行的代码，起始于选择要运行的代码所在的文件夹
> <img src="C:\Users\41533\Documents\markdown学习\images/37.png"  style="zoom:50%">
> 5.9  点完成就好，下方的复选框可以勾上，能查看任务属性
> <img src="C:\Users\41533\Documents\markdown学习\images/38.png"  style="zoom:50%">
> 5.10 可以根据个人情况编辑触发器
> <img src="C:\Users\41533\Documents\markdown学习\images/39.png"  style="zoom:50%">

到了这里，已经能实现邮件的自动发送了。但如果你的电脑在定时任务需要执行的时候没能开机呢？或者邮件发送了却没任何提示你怎样知道邮件是否发送了呢？
为了解决这些问题。我在原有的基础上增加了发送提醒功能。
> 增加发送提醒功能，如果给好友的祝福邮件发送成功，那就给自己发一封邮件提示邮件已发送

经过上边的练习，我相信你已经有了自己实现程序逻辑的能力，在这里就不再讲解，直接贴出代码
```python
"""
 @author : 唐仕恒
 @filename : test_邮件自动发送.py
 @createtime :2020/6/26 22:12
 @IDE : PyCharm
"""
# -*- coding: UTF-8 -*-
from SqlServer import SqlServer
from Email import Email
import datetime

def main():
    host = 'localhost'
    user = 'root'
    password = 'root'
    database = 'BIRTHDAY'
    # 连接数据库
    connect = SqlServer(host, user, password, database)
    # 查询当前日期是否有人生日
    today = datetime.date.today().strftime("%m-%d")
    sql = 'select top 10 name, email from tb_birthday ' + ' where right(birthday, 5) = \'' + today + '\''
    result = connect.get_all(sql)
    # 如果有人生日，发送生日祝福邮件
    if result:
        # 有记录，建立邮箱连接
        MailServer = 'smtp.163.com'
        port = 465
        email = '17073858552@163.com'
        password = open('files/password', encoding='utf-8').read()
        emailConnect = Email(MailServer, port, email, password)
        sender = '17073858552@163.com'
        # 多个人同一天生日时发送多份邮件
        for row in result:
            # 设置发件人和邮件主题
            subject = '生日祝福'
            # 收件人
            name = row[0]
            to = row[1]
            text = name + ',祝你生日快乐！'
            # 自动发送邮件
            emailConnect.sendmail(sender, to, subject, text)
            # 邮件发送成功提醒
            subject = '邮件发送提醒'
            to = '415331174@qq.com'
            text = name + '的生日祝福已发送成功'
            emailConnect.sendmail(sender, to, subject, text)

if __name__ == '__main__':
    main()
```





好了，到这里就全部结束了，第一次写，主要是为了记录自己的学习过程。有许多地方写的不好，对于python的语法格式也不太熟练。如果有什么问题欢迎一起来探讨，共同进步。



最后，感谢B站UP酒坛坛儿、优就业的视频讲解，给我的学习提供了很大的帮助